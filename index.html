<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ³•ä»¤æ¤œç´¢ - çµ±åˆæ³•ä»¤é–²è¦§ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    /* æ¤œç´¢ç”»é¢å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .search-container {
      background-color: #fff;
      padding: 2rem;
      margin: 2rem auto;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-container h1 {
      margin: 0 0 1.5rem 0;
      font-size: 1.75rem;
      color: #333;
      text-align: center;
    }

    #search-form {
      display: flex;
      gap: 0.5rem;
    }

    #search-query {
      flex: 1;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s;
    }

    #search-query:focus {
      border-color: #0066cc;
    }

    #search-button {
      padding: 0.75rem 2rem;
      font-size: 1rem;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    #search-button:hover {
      background-color: #0052a3;
    }

    #search-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* è©³ç´°æ¤œç´¢ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    .toggle-advanced-btn {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    .toggle-advanced-btn:hover {
      background-color: #e0e0e0;
    }

    /* è©³ç´°æ¤œç´¢ãƒ‘ãƒãƒ« */
    .advanced-search-panel {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .search-option-group {
      margin-bottom: 1.5rem;
    }

    .option-label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 0.5rem;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      cursor: pointer;
    }

    #category-select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .search-option-group small {
      display: block;
      color: #666;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }

    .date-range-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .date-range-group input[type="date"] {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .date-separator {
      color: #666;
    }

    .search-actions {
      margin-top: 1.5rem;
      text-align: right;
    }

    .clear-button {
      padding: 0.5rem 1.5rem;
      font-size: 0.9rem;
      background-color: #fff;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-button:hover {
      background-color: #f5f5f5;
      border-color: #999;
      color: #333;
    }

    /* é©ç”¨ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º */
    #applied-filters {
      padding: 0.75rem 1rem;
      background-color: #e3f2fd;
      border-left: 3px solid #0066cc;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      border-radius: 4px;
      display: none;
    }

    #applied-filters:not(:empty) {
      display: block;
    }

    #applied-filters strong {
      color: #0066cc;
    }

    /* æ³•ä»¤ç¨®åˆ¥ãƒãƒƒã‚¸ */
    .law-type-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      margin-right: 0.5rem;
    }

    .law-type-Constitution {
      background-color: #8e24aa;
    }

    .law-type-Act {
      background-color: #0066cc;
    }

    .law-type-CabinetOrder {
      background-color: #ff6600;
    }

    .law-type-ImperialOrder {
      background-color: #c62828;
    }

    .law-type-MinisterialOrdinance {
      background-color: #00897b;
    }

    .law-type-Rule {
      background-color: #6d4c41;
    }

    .law-type-Misc {
      background-color: #757575;
    }

    .results-container {
      max-width: 800px;
      margin: 0 auto 2rem;
    }

    #result-count {
      padding: 1rem 2rem;
      color: #666;
      font-size: 0.9rem;
    }

    #result-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #result-list li {
      background-color: #fff;
      padding: 1.25rem 2rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.2s;
    }

    #result-list li:hover {
      background-color: #f0f7ff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .law-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 0.5rem;
      display: block;
    }

    .law-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
      color: #666;
      flex-wrap: wrap;
    }

    .law-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .pagination {
      max-width: 800px;
      margin: 0 auto 2rem;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .pagination button {
      padding: 0.5rem 1.5rem;
      font-size: 0.9rem;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .pagination button:hover:not(:disabled) {
      background-color: #0052a3;
    }

    .pagination button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #page-info {
      color: #666;
      font-size: 0.9rem;
    }

    #spinner.visible {
      display: flex;
    }

    .empty-message {
      text-align: center;
      padding: 3rem 2rem;
      color: #666;
      font-size: 1.1rem;
    }

    .error-message {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 1rem 2rem;
      margin: 1rem auto;
      max-width: 800px;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .search-container {
        margin: 1rem;
        padding: 1.5rem;
      }

      .search-container h1 {
        font-size: 1.5rem;
      }

      #search-form {
        flex-direction: column;
      }

      #search-button {
        width: 100%;
      }

      .advanced-search-panel {
        padding: 1rem;
      }

      .checkbox-group {
        flex-direction: column;
        gap: 0.5rem;
      }

      .date-range-group {
        flex-direction: column;
        align-items: stretch;
      }

      .date-separator {
        text-align: center;
      }

      .results-container,
      .pagination {
        margin-left: 1rem;
        margin-right: 1rem;
      }

      #result-list li {
        padding: 1rem;
      }

      .law-meta {
        flex-direction: column;
        gap: 0.5rem;
      }

      .pagination {
        flex-direction: column;
        gap: 1rem;
      }

      .pagination button {
        width: 100%;
      }

      #applied-filters {
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="spinner">
    <div id="spinner_inside">
      <p id="loading_message">æ¤œç´¢ä¸­...</p>
      <div class="lds-ellipsis">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="search-container">
    <h1>æ³•ä»¤æ¤œç´¢</h1>
    <form id="search-form">
      <input type="text" id="search-query" placeholder="æ³•ä»¤åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ç‰¹è¨±æ³•ã€æ°‘æ³•ã€è‘—ä½œæ¨©æ³•ï¼‰"
        autofocus />
      <button type="submit" id="search-button">æ¤œç´¢</button>
    </form>

    <!-- è©³ç´°æ¤œç´¢ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button type="button" id="toggle-advanced" class="toggle-advanced-btn">è©³ç´°æ¤œç´¢ â–¼</button>

    <!-- è©³ç´°æ¤œç´¢ãƒ‘ãƒãƒ« -->
    <div id="advanced-search" class="advanced-search-panel" style="display: none;">
      <!-- æ³•ä»¤ç¨®åˆ¥ -->
      <div class="search-option-group">
        <label class="option-label">æ³•ä»¤ç¨®åˆ¥:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="law_type" value="Act"> æ³•å¾‹</label>
          <label><input type="checkbox" name="law_type" value="CabinetOrder"> æ”¿ä»¤</label>
          <label><input type="checkbox" name="law_type" value="MinisterialOrdinance"> åºœçœä»¤</label>
          <label><input type="checkbox" name="law_type" value="Constitution"> æ†²æ³•</label>
          <label><input type="checkbox" name="law_type" value="ImperialOrder"> å‹…ä»¤</label>
          <label><input type="checkbox" name="law_type" value="Rule"> è¦å‰‡</label>
        </div>
      </div>

      <!-- åˆ†é‡é¸æŠ -->
      <div class="search-option-group">
        <label class="option-label" for="category-select">åˆ†é‡:</label>
        <select id="category-select" name="category_cd" multiple size="6">
          <option value="002">åˆ‘äº‹</option>
          <option value="020">åŠ´åƒ</option>
          <option value="028">æ•™è‚²</option>
          <option value="030">åšç”Ÿ</option>
          <option value="035">ç¤¾ä¼šç¦ç¥‰</option>
          <option value="041">å¸æ³•</option>
          <option value="046">æ°‘äº‹</option>
          <option value="001">æ†²æ³•</option>
          <option value="003">è²¡å‹™é€šå‰‡</option>
          <option value="013">å›½ç¨</option>
          <option value="024">é‡‘èãƒ»ä¿é™º</option>
          <option value="043">è¾²æ¥­</option>
          <option value="047">å»ºç¯‰ãƒ»ä½å®…</option>
        </select>
        <small>Ctrl/Cmdã‚­ãƒ¼ã§è¤‡æ•°é¸æŠ</small>
      </div>

      <!-- å»ƒæ­¢çŠ¶æ³ -->
      <div class="search-option-group">
        <label class="option-label">å»ƒæ­¢çŠ¶æ³:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="repeal_status" value="None" checked> ç¾è¡Œ</label>
          <label><input type="checkbox" name="repeal_status" value="Repeal"> å»ƒæ­¢</label>
          <label><input type="checkbox" name="repeal_status" value="Expire"> å¤±åŠ¹</label>
          <label><input type="checkbox" name="repeal_status" value="Suspend"> åœæ­¢</label>
        </div>
      </div>

      <!-- å…¬å¸ƒæ—¥ç¯„å›² -->
      <div class="search-option-group">
        <label class="option-label">å…¬å¸ƒæ—¥:</label>
        <div class="date-range-group">
          <input type="date" name="promulgation_date_from" placeholder="é–‹å§‹æ—¥">
          <span class="date-separator">ï½</span>
          <input type="date" name="promulgation_date_to" placeholder="çµ‚äº†æ—¥">
        </div>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="search-actions">
        <button type="button" id="clear-filters" class="clear-button">æ¡ä»¶ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢çµæœ -->
  <div class="results-container">
    <!-- é©ç”¨ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º -->
    <div id="applied-filters"></div>
    <div id="result-count"></div>
    <ul id="result-list"></ul>
  </div>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="pagination" id="pagination" style="display: none;">
    <button id="prev-page" disabled>å‰ã¸</button>
    <span id="page-info"></span>
    <button id="next-page" disabled>æ¬¡ã¸</button>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentQuery = '';
    let currentOffset = 0;
    let currentResponse = null;
    const ITEMS_PER_PAGE = 50;

    // æ³•ä»¤ç¨®åˆ¥ã®å®šç¾©
    const LAW_TYPES = {
      'Constitution': 'æ†²æ³•',
      'Act': 'æ³•å¾‹',
      'CabinetOrder': 'æ”¿ä»¤',
      'ImperialOrder': 'å‹…ä»¤',
      'MinisterialOrdinance': 'åºœçœä»¤',
      'Rule': 'è¦å‰‡',
      'Misc': 'ãã®ä»–'
    };

    // åˆ†é‡ã‚³ãƒ¼ãƒ‰ã®å®šç¾©ï¼ˆå…¨50åˆ†é¡ï¼‰
    const CATEGORIES = {
      '001': 'æ†²æ³•', '002': 'åˆ‘äº‹', '003': 'è²¡å‹™é€šå‰‡', '004': 'æ°´ç”£æ¥­',
      '005': 'è¦³å…‰', '006': 'å›½ä¼š', '007': 'è­¦å¯Ÿ', '008': 'å›½æœ‰è²¡ç”£',
      '009': 'é‰±æ¥­', '010': 'éƒµå‹™', '011': 'è¡Œæ”¿çµ„ç¹”', '012': 'æ¶ˆé˜²',
      '013': 'å›½ç¨', '014': 'å·¥æ¥­', '015': 'é›»æ°—é€šä¿¡', '016': 'å›½å®¶å…¬å‹™å“¡',
      '017': 'å›½åœŸé–‹ç™º', '018': 'äº‹æ¥­', '019': 'å•†æ¥­', '020': 'åŠ´åƒ',
      '021': 'è¡Œæ”¿æ‰‹ç¶š', '022': 'åœŸåœ°', '023': 'å›½å‚µ', '024': 'é‡‘èãƒ»ä¿é™º',
      '025': 'ç’°å¢ƒä¿å…¨', '026': 'çµ±è¨ˆ', '027': 'éƒ½å¸‚è¨ˆç”»', '028': 'æ•™è‚²',
      '029': 'å¤–å›½ç‚ºæ›¿ãƒ»è²¿æ˜“', '030': 'åšç”Ÿ', '031': 'åœ°æ–¹è‡ªæ²»', '032': 'é“è·¯',
      '033': 'æ–‡åŒ–', '034': 'é™¸é‹', '035': 'ç¤¾ä¼šç¦ç¥‰', '036': 'åœ°æ–¹è²¡æ”¿',
      '037': 'æ²³å·', '038': 'ç”£æ¥­é€šå‰‡', '039': 'æµ·é‹', '040': 'ç¤¾ä¼šä¿é™º',
      '041': 'å¸æ³•', '042': 'ç½å®³å¯¾ç­–', '043': 'è¾²æ¥­', '044': 'èˆªç©º',
      '045': 'é˜²è¡›', '046': 'æ°‘äº‹', '047': 'å»ºç¯‰ãƒ»ä½å®…', '048': 'æ—æ¥­',
      '049': 'è²¨ç‰©é‹é€', '050': 'å¤–äº‹'
    };

    // å»ƒæ­¢çŠ¶æ³ã®å®šç¾©
    const REPEAL_STATUSES = {
      'None': 'ç¾è¡Œ',
      'Repeal': 'å»ƒæ­¢',
      'Expire': 'å¤±åŠ¹',
      'Suspend': 'åœæ­¢',
      'LossOfEffectiveness': 'å®ŸåŠ¹æ€§å–ªå¤±'
    };

    // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åé›†é–¢æ•°
    function collectSearchParams(offset = 0) {
      const params = new URLSearchParams();

      // æ³•ä»¤å
      const lawTitle = document.getElementById('search-query').value.trim();
      if (lawTitle) {
        params.append('law_title', lawTitle);
      }

      // æ³•ä»¤ç¨®åˆ¥ï¼ˆè¤‡æ•°é¸æŠï¼‰
      const lawTypes = Array.from(document.querySelectorAll('input[name="law_type"]:checked'))
        .map(cb => cb.value);
      if (lawTypes.length > 0) {
        params.append('law_type', lawTypes.join(','));
      }

      // åˆ†é‡ï¼ˆè¤‡æ•°é¸æŠï¼‰
      const categories = Array.from(document.querySelectorAll('#category-select option:checked'))
        .map(opt => opt.value);
      if (categories.length > 0) {
        params.append('category_cd', categories.join(','));
      }

      // å»ƒæ­¢çŠ¶æ³ï¼ˆè¤‡æ•°é¸æŠï¼‰
      const repealStatuses = Array.from(document.querySelectorAll('input[name="repeal_status"]:checked'))
        .map(cb => cb.value);
      if (repealStatuses.length > 0) {
        params.append('repeal_status', repealStatuses.join(','));
      }

      // å…¬å¸ƒæ—¥ç¯„å›²
      const dateFrom = document.querySelector('input[name="promulgation_date_from"]').value;
      const dateTo = document.querySelector('input[name="promulgation_date_to"]').value;
      if (dateFrom) {
        params.append('promulgation_date_from', dateFrom);
      }
      if (dateTo) {
        params.append('promulgation_date_to', dateTo);
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
      params.append('limit', ITEMS_PER_PAGE.toString());
      params.append('offset', offset.toString());

      return params;
    }

    // APIå‘¼ã³å‡ºã—
    async function searchLaws(offset = 0) {
      // æ³•ä»¤API Version 2ã‚’ç›´æ¥fetchã§å‘¼ã³å‡ºã—
      const params = collectSearchParams(offset);

      const url = `https://laws.e-gov.go.jp/api/2/laws?${params}`;
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    }

    // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºåˆ¶å¾¡
    function showSpinner(show) {
      const spinner = document.getElementById('spinner');
      if (show) {
        spinner.classList.add('visible');
      } else {
        spinner.classList.remove('visible');
      }
    }

    // çµæœè¡¨ç¤º
    function displayResults(response) {
      const countEl = document.getElementById('result-count');
      const listEl = document.getElementById('result-list');
      const paginationEl = document.getElementById('pagination');

      if (!response.laws || response.laws.length === 0) {
        countEl.textContent = '';
        listEl.innerHTML = '<div class="empty-message">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        paginationEl.style.display = 'none';
        return;
      }

      // ä»¶æ•°è¡¨ç¤º
      const start = currentOffset + 1;
      const end = currentOffset + response.count;
      const total = response.total_count || response.count;
      countEl.textContent = `${total}ä»¶ä¸­ ${start}-${end}ä»¶ã‚’è¡¨ç¤º`;

      // çµæœãƒªã‚¹ãƒˆç”Ÿæˆ
      listEl.innerHTML = response.laws.map(law => {
        // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ç¢ºèª
        const lawInfo = law.law_info || {};
        const revisionInfo = law.revision_info || {};

        const lawId = lawInfo.law_id || '';
        const lawTitle = revisionInfo.law_title || '(æ³•ä»¤åä¸æ˜)';
        const lawNum = lawInfo.law_num || '';
        const lawType = lawInfo.law_type || '';
        const category = revisionInfo.category || '';

        const typeBadge = getLawTypeBadge(lawType);

        return `
          <li onclick="openLaw('${lawId}')">
            <span class="law-title">${typeBadge}${escapeHtml(lawTitle)}</span>
            <div class="law-meta">
              ${lawNum ? `<span>ğŸ“‹ ${escapeHtml(lawNum)}</span>` : ''}
              ${category ? `<span>ğŸ“‚ ${escapeHtml(category)}</span>` : ''}
            </div>
          </li>
        `;
      }).join('');

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
      updatePagination(response);
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
    function updatePagination(response) {
      const paginationEl = document.getElementById('pagination');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      const pageInfo = document.getElementById('page-info');

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
      const hasPagination = currentOffset > 0 || response.next_offset;
      paginationEl.style.display = hasPagination ? 'flex' : 'none';

      if (!hasPagination) return;

      // å‰ã¸ãƒœã‚¿ãƒ³
      prevBtn.disabled = currentOffset === 0;

      // æ¬¡ã¸ãƒœã‚¿ãƒ³
      nextBtn.disabled = !response.next_offset;

      // ãƒšãƒ¼ã‚¸æƒ…å ±
      const currentPage = Math.floor(currentOffset / ITEMS_PER_PAGE) + 1;
      const totalItems = response.total_count || response.count;
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
      pageInfo.textContent = `${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸`;
    }

    // æ³•ä»¤ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
    function openLaw(lawId) {
      if (!lawId) {
        alert('æ³•ä»¤IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }
      window.open(`viewer.html?lawid=${encodeURIComponent(lawId)}`, '_blank');
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const countEl = document.getElementById('result-count');
      const listEl = document.getElementById('result-list');
      const paginationEl = document.getElementById('pagination');

      countEl.textContent = '';
      listEl.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
      paginationEl.style.display = 'none';
    }

    // æ¤œç´¢å®Ÿè¡Œ
    async function performSearch(offset = 0) {
      currentOffset = offset;

      showSpinner(true);
      document.getElementById('search-button').disabled = true;

      try {
        const response = await searchLaws(offset);
        currentResponse = response;
        displayResults(response);
      } catch (error) {
        console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        showError('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } finally {
        showSpinner(false);
        document.getElementById('search-button').disabled = false;
      }
    }

    // æ³•ä»¤ç¨®åˆ¥ãƒãƒƒã‚¸ã‚’ç”Ÿæˆ
    function getLawTypeBadge(lawType) {
      if (!lawType) return '';
      const typeName = LAW_TYPES[lawType] || lawType;
      return `<span class="law-type-badge law-type-${lawType}">${typeName}</span>`;
    }

    // é©ç”¨ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¡¨ç¤º
    function displayAppliedFilters() {
      const filterEl = document.getElementById('applied-filters');
      const filters = [];

      // æ³•ä»¤ç¨®åˆ¥
      const lawTypes = Array.from(document.querySelectorAll('input[name="law_type"]:checked'));
      if (lawTypes.length > 0) {
        const typeNames = lawTypes.map(cb => LAW_TYPES[cb.value] || cb.value).join(', ');
        filters.push(`ç¨®åˆ¥: ${typeNames}`);
      }

      // åˆ†é‡
      const categories = Array.from(document.querySelectorAll('#category-select option:checked'));
      if (categories.length > 0) {
        const categoryNames = categories.map(opt => opt.textContent).join(', ');
        filters.push(`åˆ†é‡: ${categoryNames}`);
      }

      // å»ƒæ­¢çŠ¶æ³
      const repealStatuses = Array.from(document.querySelectorAll('input[name="repeal_status"]:checked'));
      if (repealStatuses.length > 0) {
        const statusNames = repealStatuses.map(cb => REPEAL_STATUSES[cb.value] || cb.value).join(', ');
        filters.push(`çŠ¶æ…‹: ${statusNames}`);
      }

      // å…¬å¸ƒæ—¥
      const dateFrom = document.querySelector('input[name="promulgation_date_from"]').value;
      const dateTo = document.querySelector('input[name="promulgation_date_to"]').value;
      if (dateFrom || dateTo) {
        filters.push(`å…¬å¸ƒæ—¥: ${dateFrom || 'ï½'} ï½ ${dateTo || 'ï½'}`);
      }

      filterEl.innerHTML = filters.length > 0
        ? `<strong>æ¤œç´¢æ¡ä»¶:</strong> ${filters.join(' | ')}`
        : '';
    }

    // è©³ç´°æ¤œç´¢ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('toggle-advanced').addEventListener('click', () => {
      const panel = document.getElementById('advanced-search');
      const button = document.getElementById('toggle-advanced');

      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        button.textContent = 'è©³ç´°æ¤œç´¢ â–²';
      } else {
        panel.style.display = 'none';
        button.textContent = 'è©³ç´°æ¤œç´¢ â–¼';
      }
    });

    // æ¡ä»¶ã‚¯ãƒªã‚¢
    document.getElementById('clear-filters').addEventListener('click', () => {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('input[name="law_type"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('input[name="repeal_status"]').forEach(cb => {
        cb.checked = cb.value === 'None'; // ç¾è¡Œæ³•ä»¤ã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚§ãƒƒã‚¯
      });

      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      const categorySelect = document.getElementById('category-select');
      for (let i = 0; i < categorySelect.options.length; i++) {
        categorySelect.options[i].selected = false;
      }

      // æ—¥ä»˜å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
      document.querySelector('input[name="promulgation_date_from"]').value = '';
      document.querySelector('input[name="promulgation_date_to"]').value = '';

      // é©ç”¨ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      displayAppliedFilters();
    });

    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®submitãƒãƒ³ãƒ‰ãƒ©
    document.getElementById('search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      displayAppliedFilters();
      await performSearch(0);
    });

    // å‰ã¸ãƒœã‚¿ãƒ³
    document.getElementById('prev-page').addEventListener('click', async () => {
      const newOffset = Math.max(0, currentOffset - ITEMS_PER_PAGE);
      await performSearch(newOffset);
    });

    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    document.getElementById('next-page').addEventListener('click', async () => {
      if (currentResponse && currentResponse.next_offset) {
        await performSearch(currentResponse.next_offset);
      }
    });
  </script>
</body>

</html>
